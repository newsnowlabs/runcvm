#!/bin/sh
set -e
log() { echo "RunCVM-FC-Init: $1"; }
log "Starting Firecracker VM initialization..."

mount -o remount,rw / 2>/dev/null || true
[ -d /proc ] || mkdir -p /proc; mountpoint -q /proc || mount -t proc proc /proc
[ -d /sys ] || mkdir -p /sys; mountpoint -q /sys || mount -t sysfs sysfs /sys
[ -d /dev ] || mkdir -p /dev; mountpoint -q /dev || mount -t devtmpfs devtmpfs /dev
mkdir -p /dev/pts /dev/shm
mount -t devpts devpts /dev/pts 2>/dev/null || true
mount -t tmpfs tmpfs /dev/shm 2>/dev/null || true
[ -e /dev/fd ] || ln -sf /proc/self/fd /dev/fd
log "Filesystems mounted"

[ -f /.runcvm/config ] && . /.runcvm/config

ip link set lo up 2>/dev/null || true
if [ -f "/.runcvm/network/devices/eth0" ]; then
  read DOCKER_IF DOCKER_IF_MAC DOCKER_IF_MTU DOCKER_IF_IP DOCKER_IF_IP_NETPREFIX DOCKER_IF_IP_GW < /.runcvm/network/devices/eth0
  [ -n "$DOCKER_IF_IP" ] && ip addr add "$DOCKER_IF_IP/$DOCKER_IF_IP_NETPREFIX" broadcast + dev eth0 2>/dev/null || true
  ip link set eth0 up mtu "${DOCKER_IF_MTU:-1500}" 2>/dev/null || true
  [ -n "$DOCKER_IF_IP_GW" ] && [ "$DOCKER_IF_IP_GW" != "-" ] && ip route add default via "$DOCKER_IF_IP_GW" dev eth0 2>/dev/null || true
  log "Network: $DOCKER_IF_IP"
fi

[ -f /etc/hostname ] && hostname -F /etc/hostname
[ -f /.runcvm/pwd ] && cd "$(cat /.runcvm/pwd)" 2>/dev/null || cd /

log "Launching entrypoint..."
if [ -f /.runcvm/entrypoint ]; then
  exec $(cat /.runcvm/entrypoint | tr '\n' ' ')
else
  exec /bin/sh -l
fi