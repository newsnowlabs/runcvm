#!/bin/sh
# /init - Firecracker VM init script
# This runs as PID 1 and sets up the system before starting the container entrypoint

# Fail on errors (but we handle some specially)
set -e

echo "RunCVM-FC: Init starting..."

# ============================================================
# MOUNT ESSENTIAL FILESYSTEMS
# ============================================================

# Mount proc if not mounted
if ! mountpoint -q /proc 2>/dev/null; then
    echo "RunCVM-FC: Mounting /proc..."
    mkdir -p /proc
    mount -t proc proc /proc
fi

# Mount sysfs if not mounted
if ! mountpoint -q /sys 2>/dev/null; then
    echo "RunCVM-FC: Mounting /sys..."
    mkdir -p /sys
    mount -t sysfs sysfs /sys
fi

# Mount devtmpfs if not mounted (kernel should auto-mount if CONFIG_DEVTMPFS_MOUNT=y)
if ! mountpoint -q /dev 2>/dev/null; then
    echo "RunCVM-FC: Mounting /dev..."
    mkdir -p /dev
    mount -t devtmpfs devtmpfs /dev
fi

# Create essential device nodes if they don't exist
echo "RunCVM-FC: Setting up device nodes..."
[ -e /dev/null ]    || mknod -m 666 /dev/null c 1 3
[ -e /dev/zero ]    || mknod -m 666 /dev/zero c 1 5
[ -e /dev/random ]  || mknod -m 666 /dev/random c 1 8
[ -e /dev/urandom ] || mknod -m 666 /dev/urandom c 1 9
[ -e /dev/tty ]     || mknod -m 666 /dev/tty c 5 0
[ -e /dev/console ] || mknod -m 600 /dev/console c 5 1
[ -e /dev/ptmx ]    || mknod -m 666 /dev/ptmx c 5 2

# Create pts directory and mount devpts
mkdir -p /dev/pts
if ! mountpoint -q /dev/pts 2>/dev/null; then
    mount -t devpts devpts /dev/pts
fi

# Create shm directory and mount tmpfs
mkdir -p /dev/shm
if ! mountpoint -q /dev/shm 2>/dev/null; then
    mount -t tmpfs tmpfs /dev/shm
fi

# Mount tmpfs on /run
mkdir -p /run
if ! mountpoint -q /run 2>/dev/null; then
    mount -t tmpfs tmpfs /run
fi

# ============================================================
# SETUP CONSOLE
# ============================================================

# Redirect console output
exec 0</dev/console
exec 1>/dev/console
exec 2>/dev/console

echo "RunCVM-FC: Console setup complete"

# ============================================================
# NETWORK SETUP (if config exists)
# ============================================================

if [ -f /.runcvm/network.conf ]; then
    echo "RunCVM-FC: Configuring network..."
    . /.runcvm/network.conf
    
    if [ -n "$RUNCVM_IP" ] && [ -n "$RUNCVM_GW" ]; then
        # Bring up eth0
        ip link set eth0 up 2>/dev/null || true
        ip addr add "$RUNCVM_IP" dev eth0 2>/dev/null || true
        ip route add default via "${RUNCVM_GW%/*}" 2>/dev/null || true
        echo "RunCVM-FC: Network configured: $RUNCVM_IP via $RUNCVM_GW"
    fi
    
    # Setup DNS
    if [ -n "$RUNCVM_DNS" ]; then
        echo "nameserver $RUNCVM_DNS" > /etc/resolv.conf
    fi
fi

# ============================================================
# HOSTNAME
# ============================================================

if [ -f /.runcvm/hostname ]; then
    hostname $(cat /.runcvm/hostname)
    echo "RunCVM-FC: Hostname set to $(hostname)"
fi

# ============================================================
# EXECUTE THE ACTUAL ENTRYPOINT
# ============================================================

# Read saved entrypoint
ENTRYPOINT=""
ENTRYPOINT_ARGS=""

if [ -f /.runcvm/entrypoint ]; then
    ENTRYPOINT=$(cat /.runcvm/entrypoint)
fi

if [ -f /.runcvm/entrypoint_args ]; then
    ENTRYPOINT_ARGS=$(cat /.runcvm/entrypoint_args)
fi

# Default to /bin/sh if no entrypoint
if [ -z "$ENTRYPOINT" ]; then
    ENTRYPOINT="/bin/sh"
fi

echo "RunCVM-FC: Starting entrypoint: $ENTRYPOINT $ENTRYPOINT_ARGS"

# Change to working directory if specified
if [ -f /.runcvm/workdir ]; then
    cd $(cat /.runcvm/workdir) 2>/dev/null || true
fi

# Load environment variables if they exist
if [ -f /.runcvm/environment ]; then
    set -a
    . /.runcvm/environment
    set +a
fi

# Execute the entrypoint
# Use exec to replace this init process
exec $ENTRYPOINT $ENTRYPOINT_ARGS

# If exec fails, drop to shell
echo "RunCVM-FC: ERROR - Failed to exec entrypoint, dropping to shell"
exec /bin/sh